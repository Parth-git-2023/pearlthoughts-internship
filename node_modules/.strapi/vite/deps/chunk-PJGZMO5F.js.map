{
  "version": 3,
  "sources": ["../../../../../packages/core/admin/admin/src/hooks/useRBAC.ts", "../../../../../packages/core/admin/admin/src/utils/once.ts", "../../../../../packages/core/admin/admin/src/hooks/usePrev.ts"],
  "sourcesContent": ["import * as React from 'react';\r\n\r\nimport isEqual from 'lodash/isEqual';\r\n\r\nimport { useAuth, Permission } from '../features/Auth';\r\nimport { once } from '../utils/once';\r\nimport { capitalise } from '../utils/strings';\r\n\r\nimport { usePrev } from './usePrev';\r\n\r\ntype AllowedActions = Record<string, boolean>;\r\n\r\n/**\r\n * @public\r\n * @description This hooks takes an object or array of permissions (the latter preferred) and\r\n * runs through them to match against the current user's permissions as well as the RBAC middleware\r\n * system checking any conditions that may be present. It returns the filtered permissions as the complete\r\n * object from the API and a set of actions that can be performed. An action is derived from the last part\r\n * of the permission action e.g. `admin::roles.create` would be `canCreate`. If there's a hyphen in the action\r\n * this is removed and capitalised e.g `admin::roles.create-draft` would be `canCreateDraft`.\r\n * @example\r\n * ```tsx\r\n * import { Page, useRBAC } from '@strapi/strapi/admin'\r\n *\r\n * const MyProtectedPage = () => {\r\n *  const { allowedActions, isLoading, error, permissions } = useRBAC([{ action: 'admin::roles.create' }])\r\n *\r\n *  if(isLoading) {\r\n *    return <Page.Loading />\r\n *  }\r\n *\r\n *  if(error){\r\n *    return <Page.Error />\r\n *  }\r\n *\r\n *  if(!allowedActions.canCreate) {\r\n *    return null\r\n *  }\r\n *\r\n *  return <MyPage permissions={permissions} />\r\n * }\r\n * ```\r\n */\r\nconst useRBAC = (\r\n  permissionsToCheck: Record<string, Permission[]> | Permission[] = [],\r\n  passedPermissions?: Permission[],\r\n  rawQueryContext?: string\r\n): {\r\n  allowedActions: AllowedActions;\r\n  isLoading: boolean;\r\n  error?: unknown;\r\n  permissions: Permission[];\r\n} => {\r\n  const isLoadingAuth = useAuth('useRBAC', (state) => state.isLoading);\r\n  const [isLoading, setIsLoading] = React.useState(true);\r\n  const [error, setError] = React.useState<unknown>();\r\n  const [data, setData] = React.useState<Record<string, boolean>>();\r\n\r\n  const warnOnce = React.useMemo(() => once(console.warn), []);\r\n\r\n  const actualPermissionsToCheck: Permission[] = React.useMemo(() => {\r\n    if (Array.isArray(permissionsToCheck)) {\r\n      return permissionsToCheck;\r\n    } else {\r\n      warnOnce(\r\n        'useRBAC: The first argument should be an array of permissions, not an object. This will be deprecated in the future.'\r\n      );\r\n\r\n      return Object.values(permissionsToCheck).flat();\r\n    }\r\n  }, [permissionsToCheck, warnOnce]);\r\n\r\n  /**\r\n   * This is the default value we return until the queryResults[i].data\r\n   * are all resolved with data. This preserves the original behaviour.\r\n   */\r\n  const defaultAllowedActions = React.useMemo(() => {\r\n    return actualPermissionsToCheck.reduce<Record<string, boolean>>((acc, permission) => {\r\n      return {\r\n        ...acc,\r\n        [getActionName(permission)]: false,\r\n      };\r\n    }, {});\r\n  }, [actualPermissionsToCheck]);\r\n\r\n  const checkUserHasPermissions = useAuth('useRBAC', (state) => state.checkUserHasPermissions);\r\n\r\n  const permssionsChecked = usePrev(actualPermissionsToCheck);\r\n  const contextChecked = usePrev(rawQueryContext);\r\n\r\n  React.useEffect(() => {\r\n    if (\r\n      !isEqual(permssionsChecked, actualPermissionsToCheck) ||\r\n      // TODO: also run this when the query context changes\r\n      contextChecked !== rawQueryContext\r\n    ) {\r\n      setIsLoading(true);\r\n      setData(undefined);\r\n      setError(undefined);\r\n\r\n      checkUserHasPermissions(actualPermissionsToCheck, passedPermissions, rawQueryContext)\r\n        .then((res) => {\r\n          if (res) {\r\n            setData(\r\n              res.reduce<Record<string, boolean>>((acc, permission) => {\r\n                return {\r\n                  ...acc,\r\n                  [getActionName(permission)]: true,\r\n                };\r\n              }, {})\r\n            );\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          setError(err);\r\n        })\r\n        .finally(() => {\r\n          setIsLoading(false);\r\n        });\r\n    }\r\n  }, [\r\n    actualPermissionsToCheck,\r\n    checkUserHasPermissions,\r\n    passedPermissions,\r\n    permissionsToCheck,\r\n    permssionsChecked,\r\n    contextChecked,\r\n    rawQueryContext,\r\n  ]);\r\n\r\n  /**\r\n   * This hook originally would not return allowedActions\r\n   * until all the checks were complete.\r\n   */\r\n  const allowedActions = Object.entries({\r\n    ...defaultAllowedActions,\r\n    ...data,\r\n  }).reduce((acc, [name, allowed]) => {\r\n    acc[`can${capitalise(name)}`] = allowed;\r\n\r\n    return acc;\r\n  }, {} as AllowedActions);\r\n\r\n  return {\r\n    allowedActions,\r\n    permissions: actualPermissionsToCheck,\r\n    isLoading: isLoading || isLoadingAuth,\r\n    error,\r\n  };\r\n};\r\n\r\nconst getActionName = (permission: Permission): string => {\r\n  const [action = ''] = permission.action.split('.').slice(-1);\r\n  return action.split('-').map(capitalise).join('');\r\n};\r\n\r\nexport { useRBAC };\r\nexport type { AllowedActions };\r\n", "export const once = <TFunc extends (...args: any) => any>(fn: TFunc) => {\r\n  const func = fn;\r\n  let called = false;\r\n\r\n  if (typeof func !== 'function') {\r\n    throw new TypeError(`once requires a function parameter`);\r\n  }\r\n\r\n  return (...args: any) => {\r\n    if (!called && process.env.NODE_ENV === 'development') {\r\n      func(...args);\r\n      called = true;\r\n    }\r\n  };\r\n};\r\n", "import { useEffect, useRef } from 'react';\r\n\r\nexport const usePrev = <T>(value: T): T | undefined => {\r\n  const ref = useRef<T>();\r\n\r\n  useEffect(() => {\r\n    ref.current = value;\r\n  }, [value]);\r\n\r\n  return ref.current;\r\n};\r\n"],
  "mappings": "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",
  "names": ["isEqual"]
}
