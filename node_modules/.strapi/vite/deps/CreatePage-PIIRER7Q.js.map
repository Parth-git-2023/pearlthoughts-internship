{
  "version": 3,
  "sources": ["../../../../../packages/core/admin/admin/src/pages/Settings/pages/Roles/CreatePage.tsx"],
  "sourcesContent": ["import * as React from 'react';\r\n\r\nimport {\r\n  Box,\r\n  Button,\r\n  Field,\r\n  Flex,\r\n  Grid,\r\n  Main,\r\n  Textarea,\r\n  TextInput,\r\n  Typography,\r\n} from '@strapi/design-system';\r\nimport { Check } from '@strapi/icons';\r\nimport { format } from 'date-fns';\r\nimport { Formik, Form, FormikHelpers } from 'formik';\r\nimport { useIntl } from 'react-intl';\r\nimport { useNavigate, useParams } from 'react-router-dom';\r\nimport { styled } from 'styled-components';\r\nimport * as yup from 'yup';\r\n\r\nimport { Layouts } from '../../../../components/Layouts/Layout';\r\nimport { Page } from '../../../../components/PageHelpers';\r\nimport { useTypedSelector } from '../../../../core/store/hooks';\r\nimport { BackButton } from '../../../../features/BackButton';\r\nimport { useNotification } from '../../../../features/Notifications';\r\nimport { useTracking } from '../../../../features/Tracking';\r\nimport { useAPIErrorHandler } from '../../../../hooks/useAPIErrorHandler';\r\nimport {\r\n  useCreateRoleMutation,\r\n  useGetRolePermissionLayoutQuery,\r\n  useGetRolePermissionsQuery,\r\n  useUpdateRolePermissionsMutation,\r\n} from '../../../../services/users';\r\nimport { isBaseQueryError } from '../../../../utils/baseQuery';\r\nimport { translatedErrors } from '../../../../utils/translatedErrors';\r\n\r\nimport { Permissions, PermissionsAPI } from './components/Permissions';\r\n\r\n/* -------------------------------------------------------------------------------------------------\r\n * CreatePage\r\n * -----------------------------------------------------------------------------------------------*/\r\n\r\nconst CREATE_SCHEMA = yup.object().shape({\r\n  name: yup.string().required(translatedErrors.required.id),\r\n  description: yup.string().required(translatedErrors.required.id),\r\n});\r\n\r\n/**\r\n * TODO: be nice if we could just infer this from the schema\r\n */\r\ninterface CreateRoleFormValues {\r\n  name: string;\r\n  description: string;\r\n}\r\n\r\n/**\r\n * TODO: this whole section of the app needs refactoring. Using a ref to\r\n * manage the state of the child is nonsensical.\r\n */\r\nconst CreatePage = () => {\r\n  const { id } = useParams();\r\n  const { toggleNotification } = useNotification();\r\n  const { formatMessage } = useIntl();\r\n  const navigate = useNavigate();\r\n  const permissionsRef = React.useRef<PermissionsAPI>(null);\r\n  const { trackUsage } = useTracking();\r\n  const {\r\n    _unstableFormatAPIError: formatAPIError,\r\n    _unstableFormatValidationErrors: formatValidationErrors,\r\n  } = useAPIErrorHandler();\r\n\r\n  const { isLoading: isLoadingPermissionsLayout, currentData: permissionsLayout } =\r\n    useGetRolePermissionLayoutQuery({\r\n      /**\r\n       * Role here is a query param so if there's no role we pass an empty string\r\n       * which returns us a default layout.\r\n       */\r\n      role: id ?? '',\r\n    });\r\n\r\n  /**\r\n   * We need this so if we're cloning a role, we can fetch\r\n   * the current permissions that role has.\r\n   */\r\n  const { currentData: rolePermissions, isLoading: isLoadingRole } = useGetRolePermissionsQuery(\r\n    {\r\n      id: id!,\r\n    },\r\n    {\r\n      skip: !id,\r\n      refetchOnMountOrArgChange: true,\r\n    }\r\n  );\r\n\r\n  const [createRole] = useCreateRoleMutation();\r\n  const [updateRolePermissions] = useUpdateRolePermissionsMutation();\r\n\r\n  const handleCreateRoleSubmit = async (\r\n    data: CreateRoleFormValues,\r\n    formik: FormikHelpers<CreateRoleFormValues>\r\n  ) => {\r\n    try {\r\n      if (id) {\r\n        trackUsage('willDuplicateRole');\r\n      } else {\r\n        trackUsage('willCreateNewRole');\r\n      }\r\n\r\n      const res = await createRole(data);\r\n\r\n      if ('error' in res) {\r\n        if (isBaseQueryError(res.error) && res.error.name === 'ValidationError') {\r\n          formik.setErrors(formatValidationErrors(res.error));\r\n        } else {\r\n          toggleNotification({\r\n            type: 'danger',\r\n            message: formatAPIError(res.error),\r\n          });\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      const { permissionsToSend } = permissionsRef.current?.getPermissions() ?? {};\r\n\r\n      if (res.data.id && Array.isArray(permissionsToSend) && permissionsToSend.length > 0) {\r\n        const updateRes = await updateRolePermissions({\r\n          id: res.data.id,\r\n          permissions: permissionsToSend,\r\n        });\r\n\r\n        if ('error' in updateRes) {\r\n          if (isBaseQueryError(updateRes.error) && updateRes.error.name === 'ValidationError') {\r\n            formik.setErrors(formatValidationErrors(updateRes.error));\r\n          } else {\r\n            toggleNotification({\r\n              type: 'danger',\r\n              message: formatAPIError(updateRes.error),\r\n            });\r\n          }\r\n\r\n          return;\r\n        }\r\n      }\r\n\r\n      toggleNotification({\r\n        type: 'success',\r\n        message: formatMessage({ id: 'Settings.roles.created', defaultMessage: 'created' }),\r\n      });\r\n\r\n      navigate(`../roles/${res.data.id.toString()}`, { replace: true });\r\n    } catch (err) {\r\n      toggleNotification({\r\n        type: 'danger',\r\n        message: formatMessage({ id: 'notification.error', defaultMessage: 'An error occurred' }),\r\n      });\r\n    }\r\n  };\r\n\r\n  if ((isLoadingPermissionsLayout && isLoadingRole) || !permissionsLayout) {\r\n    return <Page.Loading />;\r\n  }\r\n\r\n  return (\r\n    <Main>\r\n      <Page.Title>\r\n        {formatMessage(\r\n          { id: 'Settings.PageTitle', defaultMessage: 'Settings - {name}' },\r\n          {\r\n            name: 'Roles',\r\n          }\r\n        )}\r\n      </Page.Title>\r\n      <Formik\r\n        initialValues={\r\n          {\r\n            name: '',\r\n            description: `${formatMessage({\r\n              id: 'Settings.roles.form.created',\r\n              defaultMessage: 'Created',\r\n            })} ${format(new Date(), 'PPP')}`,\r\n          } satisfies CreateRoleFormValues\r\n        }\r\n        onSubmit={handleCreateRoleSubmit}\r\n        validationSchema={CREATE_SCHEMA}\r\n        validateOnChange={false}\r\n      >\r\n        {({ values, errors, handleReset, handleChange, isSubmitting }) => (\r\n          <Form>\r\n            <>\r\n              <Layouts.Header\r\n                primaryAction={\r\n                  <Flex gap={2}>\r\n                    <Button\r\n                      variant=\"secondary\"\r\n                      onClick={() => {\r\n                        handleReset();\r\n                        permissionsRef.current?.resetForm();\r\n                      }}\r\n                    >\r\n                      {formatMessage({\r\n                        id: 'app.components.Button.reset',\r\n                        defaultMessage: 'Reset',\r\n                      })}\r\n                    </Button>\r\n                    <Button type=\"submit\" loading={isSubmitting} startIcon={<Check />}>\r\n                      {formatMessage({\r\n                        id: 'global.save',\r\n                        defaultMessage: 'Save',\r\n                      })}\r\n                    </Button>\r\n                  </Flex>\r\n                }\r\n                title={formatMessage({\r\n                  id: 'Settings.roles.create.title',\r\n                  defaultMessage: 'Create a role',\r\n                })}\r\n                subtitle={formatMessage({\r\n                  id: 'Settings.roles.create.description',\r\n                  defaultMessage: 'Define the rights given to the role',\r\n                })}\r\n                navigationAction={<BackButton fallback=\"../roles\" />}\r\n              />\r\n              <Layouts.Content>\r\n                <Flex direction=\"column\" alignItems=\"stretch\" gap={6}>\r\n                  <Box background=\"neutral0\" padding={6} shadow=\"filterShadow\" hasRadius>\r\n                    <Flex direction=\"column\" alignItems=\"stretch\" gap={4}>\r\n                      <Flex justifyContent=\"space-between\">\r\n                        <Box>\r\n                          <Box>\r\n                            <Typography fontWeight=\"bold\">\r\n                              {formatMessage({\r\n                                id: 'global.details',\r\n                                defaultMessage: 'Details',\r\n                              })}\r\n                            </Typography>\r\n                          </Box>\r\n                          <Box>\r\n                            <Typography variant=\"pi\" textColor=\"neutral600\">\r\n                              {formatMessage({\r\n                                id: 'Settings.roles.form.description',\r\n                                defaultMessage: 'Name and description of the role',\r\n                              })}\r\n                            </Typography>\r\n                          </Box>\r\n                        </Box>\r\n                        <UsersRoleNumber>\r\n                          {formatMessage(\r\n                            {\r\n                              id: 'Settings.roles.form.button.users-with-role',\r\n                              defaultMessage:\r\n                                '{number, plural, =0 {# users} one {# user} other {# users}} with this role',\r\n                            },\r\n                            { number: 0 }\r\n                          )}\r\n                        </UsersRoleNumber>\r\n                      </Flex>\r\n                      <Grid.Root gap={4}>\r\n                        <Grid.Item col={6} direction=\"column\" alignItems=\"stretch\">\r\n                          <Field.Root\r\n                            name=\"name\"\r\n                            error={errors.name && formatMessage({ id: errors.name })}\r\n                            required\r\n                          >\r\n                            <Field.Label>\r\n                              {formatMessage({\r\n                                id: 'global.name',\r\n                                defaultMessage: 'Name',\r\n                              })}\r\n                            </Field.Label>\r\n                            <TextInput onChange={handleChange} value={values.name} />\r\n                            <Field.Error />\r\n                          </Field.Root>\r\n                        </Grid.Item>\r\n                        <Grid.Item col={6} direction=\"column\" alignItems=\"stretch\">\r\n                          <Field.Root\r\n                            name=\"description\"\r\n                            error={errors.description && formatMessage({ id: errors.description })}\r\n                          >\r\n                            <Field.Label>\r\n                              {formatMessage({\r\n                                id: 'global.description',\r\n                                defaultMessage: 'Description',\r\n                              })}\r\n                            </Field.Label>\r\n                            <Textarea onChange={handleChange} value={values.description} />\r\n                          </Field.Root>\r\n                        </Grid.Item>\r\n                      </Grid.Root>\r\n                    </Flex>\r\n                  </Box>\r\n                  <Box shadow=\"filterShadow\" hasRadius>\r\n                    <Permissions\r\n                      isFormDisabled={false}\r\n                      ref={permissionsRef}\r\n                      permissions={rolePermissions}\r\n                      layout={permissionsLayout}\r\n                    />\r\n                  </Box>\r\n                </Flex>\r\n              </Layouts.Content>\r\n            </>\r\n          </Form>\r\n        )}\r\n      </Formik>\r\n    </Main>\r\n  );\r\n};\r\n\r\nconst UsersRoleNumber = styled.div`\r\n  border: 1px solid ${({ theme }) => theme.colors.primary200};\r\n  background: ${({ theme }) => theme.colors.primary100};\r\n  padding: ${({ theme }) => `${theme.spaces[2]} ${theme.spaces[4]}`};\r\n  color: ${({ theme }) => theme.colors.primary600};\r\n  border-radius: ${({ theme }) => theme.borderRadius};\r\n  font-size: 1.2rem;\r\n  font-weight: bold;\r\n`;\r\n\r\n/* -------------------------------------------------------------------------------------------------\r\n * ProtectedCreatePage\r\n * -----------------------------------------------------------------------------------------------*/\r\n\r\nconst ProtectedCreatePage = () => {\r\n  const permissions = useTypedSelector(\r\n    (state) => state.admin_app.permissions.settings?.roles.create\r\n  );\r\n\r\n  return (\r\n    <Page.Protect permissions={permissions}>\r\n      <CreatePage />\r\n    </Page.Protect>\r\n  );\r\n};\r\n\r\nexport { CreatePage, ProtectedCreatePage };\r\n"],
  "mappings": "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",
  "names": ["create"]
}
